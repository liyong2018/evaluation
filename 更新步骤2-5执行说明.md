# 标准减灾能力评估模型 - 步骤2到步骤5算法配置更新说明

## 文件说明

**文件名**: `update_steps_2_to_5.sql`  
**编码**: UTF-8  
**创建时间**: 2025-10-12  
**目的**: 更新标准减灾能力评估模型的步骤2-5的算法配置

## 更新内容概览

此SQL脚本完整配置了标准减灾能力评估模型的以下步骤：

### 步骤2：属性向量归一化
- **算法数量**: 8个
- **功能**: 对8个二级指标进行向量归一化处理
- **公式**: `归一化值 = 本乡镇指标值 / SQRT(SUMSQ(全部乡镇指标值))`
- **算法列表**:
  1. 队伍管理能力归一化
  2. 风险评估能力归一化
  3. 财政投入能力归一化
  4. 物资储备能力归一化
  5. 医疗保障能力归一化
  6. 自救互救能力归一化
  7. 公众避险能力归一化
  8. 转移安置能力归一化

### 步骤3：定权计算
- **算法数量**: 16个（分为两部分）
- **功能**: 使用权重对归一化后的数据进行加权

#### 第一部分：一级指标定权（1-8号算法）
- **公式**: `定权值 = 归一化值 × 二级权重`
- 包含8个二级指标的定权计算

#### 第二部分：乡镇街道减灾能力定权（9-16号算法）
- **公式**: `综合定权值 = 归一化值 × 一级权重 × 二级权重`
- 包含8个二级指标的综合定权计算

### 步骤4：优劣解算法计算
- **算法数量**: 8个
- **功能**: 基于TOPSIS方法计算到正理想解（优）和负理想解（差）的距离

#### 一级指标优劣解（1-6号算法）
1. 灾害管理能力优解/差解
2. 灾害备灾能力优解/差解
3. 自救转移能力优解/差解

#### 综合减灾能力优劣解（7-8号算法）
1. 综合减灾能力优解
2. 综合减灾能力差解

**公式**:
- 优解: `SQRT((指标最大值 - 本乡镇指标值)² + ...)`
- 差解: `SQRT((指标最小值 - 本乡镇指标值)² + ...)`

### 步骤5：能力值计算与分级
- **算法数量**: 8个（分为两部分）

#### 第一部分：能力值计算（1-4号算法）
- **公式**: `能力值 = 差解距离 / (差解距离 + 优解距离)`
- 计算项目:
  1. 灾害管理能力值
  2. 灾害备灾能力值
  3. 自救转移能力值
  4. 综合减灾能力值

#### 第二部分：能力分级（5-8号算法）
- **分级方法**: 基于均值(μ)和标准差(σ)进行五级分类
- **分级标准**:
  - **强**: value ≥ μ+1.5σ
  - **较强**: μ+0.5σ ≤ value < μ+1.5σ
  - **中等**: μ-0.5σ ≤ value < μ+0.5σ
  - **较弱**: μ-1.5σ ≤ value < μ-0.5σ
  - **弱**: value < μ-1.5σ

## 执行步骤

### 方法1: 使用MySQL命令行工具

```powershell
# 1. 进入MySQL命令行（需要输入root密码）
mysql -u root -p

# 2. 在MySQL命令行中执行脚本
source C:\Users\Administrator\Development\evaluation\update_steps_2_to_5.sql

# 或者使用完整路径
\. C:\Users\Administrator\Development\evaluation\update_steps_2_to_5.sql
```

### 方法2: 使用PowerShell一行命令

```powershell
# 需要输入MySQL root密码
Get-Content "C:\Users\Administrator\Development\evaluation\update_steps_2_to_5.sql" | mysql -u root -p evaluate_db
```

### 方法3: 使用MySQL Workbench

1. 打开 MySQL Workbench
2. 连接到 `evaluate_db` 数据库
3. 打开文件: `File > Open SQL Script...`
4. 选择 `update_steps_2_to_5.sql`
5. 点击执行按钮（⚡闪电图标）

### 方法4: 使用命令行直接执行（推荐）

```powershell
# 执行SQL脚本（需要提供MySQL密码）
mysql -u root -p --default-character-set=utf8mb4 evaluate_db < "C:\Users\Administrator\Development\evaluation\update_steps_2_to_5.sql"
```

## 执行前检查

在执行脚本之前，请确保：

1. ✅ MySQL服务正在运行
2. ✅ 数据库 `evaluate_db` 已存在
3. ✅ 表 `evaluation_model`, `model_step`, `step_algorithm` 已存在
4. ✅ 标准模型（model_code = 'STANDARD_MODEL'）已创建
5. ✅ 步骤1（评估指标赋值）已配置完成

**验证命令**:
```sql
USE evaluate_db;

-- 检查模型是否存在
SELECT * FROM evaluation_model WHERE model_code = 'STANDARD_MODEL';

-- 检查现有步骤
SELECT id, step_order, step_name, step_code FROM model_step WHERE model_id = (SELECT id FROM evaluation_model WHERE model_code = 'STANDARD_MODEL' LIMIT 1) ORDER BY step_order;

-- 检查步骤1的算法数量
SELECT COUNT(*) as step1_count FROM step_algorithm WHERE step_id = (SELECT id FROM model_step WHERE model_id = (SELECT id FROM evaluation_model WHERE model_code = 'STANDARD_MODEL' LIMIT 1) AND step_order = 1 LIMIT 1);
```

## 执行后验证

脚本执行成功后，会自动显示以下验证信息：

### 1. 步骤配置统计
显示每个步骤的算法数量：
- 步骤2: 8条算法记录
- 步骤3: 16条算法记录
- 步骤4: 8条算法记录
- 步骤5: 8条算法记录

### 2. 详细算法列表
显示所有算法的详细信息，包括：
- 步骤序号
- 算法序号
- 算法名称
- 算法编码
- 输出参数
- 算法描述

### 手动验证命令

```sql
USE evaluate_db;

-- 查看步骤配置统计
SELECT 
    ms.step_order as '步骤序号',
    ms.step_name as '步骤名称',
    COUNT(sa.id) as '算法数量'
FROM model_step ms
LEFT JOIN step_algorithm sa ON ms.id = sa.step_id
WHERE ms.model_id = (SELECT id FROM evaluation_model WHERE model_code = 'STANDARD_MODEL' LIMIT 1)
AND ms.step_order BETWEEN 2 AND 5
GROUP BY ms.id, ms.step_order, ms.step_name
ORDER BY ms.step_order;

-- 查看某个步骤的详细算法
SELECT 
    algorithm_order as '序号',
    algorithm_name as '算法名称',
    algorithm_code as '编码',
    output_param as '输出参数'
FROM step_algorithm
WHERE step_id = (
    SELECT id FROM model_step 
    WHERE model_id = (SELECT id FROM evaluation_model WHERE model_code = 'STANDARD_MODEL' LIMIT 1) 
    AND step_order = 2
    LIMIT 1
)
ORDER BY algorithm_order;
```

## 特殊标记说明

脚本中使用了以下特殊标记，这些标记会被后端服务识别并处理：

### @NORMALIZE
- **用途**: 表示需要对所有区域的数据进行向量归一化
- **示例**: `@NORMALIZE:teamManagement`
- **处理**: 后端会收集所有区域的指定指标值，计算平方和的平方根，然后为每个区域计算归一化值

### @TOPSIS_POSITIVE / @TOPSIS_NEGATIVE
- **用途**: 表示需要计算TOPSIS正理想解（优）或负理想解（差）
- **示例**: `@TOPSIS_POSITIVE:teamManagementWeighted,riskAssessmentWeighted`
- **处理**: 后端会找到所有指标的最大值/最小值，然后计算欧氏距离

### @GRADE
- **用途**: 表示需要基于均值和标准差进行分级
- **示例**: `@GRADE:disasterMgmtScore`
- **处理**: 后端会计算所有区域的均值和标准差，然后根据分级规则进行分类

## 权重变量说明

脚本中使用的权重变量会从 `indicator_weight` 表中动态获取：

### 一级指标权重
- `weight_DISASTER_MANAGEMENT`: 灾害管理能力一级权重
- `weight_DISASTER_PREPAREDNESS`: 灾害备灾能力一级权重
- `weight_SELF_RESCUE_TRANSFER`: 自救转移能力一级权重

### 二级指标权重
- `weight_TEAM_MANAGEMENT`: 队伍管理能力二级权重
- `weight_RISK_ASSESSMENT`: 风险评估能力二级权重
- `weight_FINANCIAL_INPUT`: 财政投入能力二级权重
- `weight_MATERIAL_RESERVE`: 物资储备能力二级权重
- `weight_MEDICAL_SUPPORT`: 医疗保障能力二级权重
- `weight_SELF_RESCUE`: 自救互救能力二级权重
- `weight_PUBLIC_AVOIDANCE`: 公众避险能力二级权重
- `weight_RELOCATION_CAPACITY`: 转移安置能力二级权重

## 注意事项

1. **编码问题**: 
   - 脚本使用UTF-8编码，确保MySQL连接也使用UTF-8编码
   - 脚本开头已包含 `SET NAMES utf8mb4;` 和 `SET CHARACTER SET utf8mb4;`

2. **数据备份**:
   - 建议执行前备份 `step_algorithm` 表
   - 备份命令: `mysqldump -u root -p evaluate_db step_algorithm > step_algorithm_backup.sql`

3. **执行顺序**:
   - 本脚本会先删除（DELETE）现有的步骤2-5的算法配置
   - 然后插入新的配置
   - 如果步骤4或步骤5不存在，会自动创建

4. **依赖关系**:
   - 步骤2依赖步骤1的输出（8个二级指标原始值）
   - 步骤3依赖步骤2的输出（8个归一化值）
   - 步骤4依赖步骤3的输出（16个定权值）
   - 步骤5依赖步骤4的输出（8个优劣解距离值）

## 故障排除

### 问题1: 中文乱码
**解决方案**: 确保MySQL连接使用UTF-8编码
```powershell
mysql -u root -p --default-character-set=utf8mb4 evaluate_db < update_steps_2_to_5.sql
```

### 问题2: 找不到模型
**错误**: `@step2_id = NULL`  
**解决方案**: 确保标准模型已创建
```sql
INSERT INTO evaluation_model (model_name, model_code, description, is_default) 
VALUES ('标准减灾能力评估模型', 'STANDARD_MODEL', '基于TOPSIS算法的标准减灾能力评估模型', 1);
```

### 问题3: 外键约束错误
**错误**: `Cannot add or update a child row: a foreign key constraint fails`  
**解决方案**: 确保 `model_step` 表中存在对应的步骤记录

### 问题4: 权限不足
**错误**: `Access denied for user 'root'@'localhost'`  
**解决方案**: 使用正确的MySQL用户名和密码

## 后续步骤

完成算法配置后，您可以：

1. **测试评估流程**: 使用前端或API执行完整的评估流程
2. **查看执行结果**: 检查 `model_execution_record` 和 `step_execution_result` 表
3. **调整权重**: 在 `indicator_weight` 表中修改权重值
4. **自定义算法**: 在不修改代码的情况下调整 `ql_expression` 字段

## 相关文档

- `temp_update_step1.sql`: 步骤1的算法配置
- `migrations/002_create_model_management.sql`: 模型管理表结构
- `WARP.md`: 项目整体说明
- `QLExpress实施指南.md`: QLExpress表达式引擎详细说明

## 技术支持

如有问题，请检查：
1. MySQL错误日志
2. 应用程序日志（位于 `logs/` 目录）
3. 数据库表结构是否完整

---

**更新完成后的预期结果**:
- ✅ 步骤2包含8个归一化算法
- ✅ 步骤3包含16个定权算法
- ✅ 步骤4包含8个优劣解算法
- ✅ 步骤5包含8个能力值与分级算法
- ✅ 总计40条算法记录
- ✅ 所有中文字符正确显示
- ✅ 算法表达式符合业务逻辑

执行本脚本后，标准减灾能力评估模型的核心算法配置即告完成！
