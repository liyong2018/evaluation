# 调试指南：修复列分组不正确的问题

## 问题描述

在"模型评估结果 - 计算结果"弹窗中，列分组显示不正确：
- 缺少步骤1
- 步骤3显示4列（应该是16列）
- 步骤4显示44列（应该是8列）

**期望的列分布**：
- 步骤1：8个输出列
- 步骤2：8个输出列
- 步骤3：16个输出列（分两张表）
- 步骤4：8个输出列
- 步骤5：8个输出列

## 调试步骤

### 第1步：查看控制台日志

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 点击单个步骤的"查看结果"按钮
4. 查看详细的列分组日志

**关键日志信息**：

```
=== 开始计算列分组 ===
Computing column groups with: {
  allColumnsCount: 48,
  allColumnsList: [...],
  stepAlgorithmOutputs: {...},
  stepOrderNames: {...},
  isMultiStep: false
}

基础列: regionCode
基础列: regionName

处理后端步骤映射: [1, 2, 3, 4, 5]

步骤 1 的输出参数: ["列名1", "列名2", ...]
  ✓ 匹配: 列名1 -> 步骤1
  ✓ 匹配: 列名2 -> 步骤1
✓ 添加动态分组: 步骤1 XXX 共 8 列

步骤 2 的输出参数: [...]
...

开始关键字兜底分组
未分配的列（XX）: [...]
  ✓ 关键字匹配[定权]: xxx (xxx)
  ✓ 关键字匹配[优劣解算]: xxx (xxx)
  ? 未匹配: xxx (xxx)

组装最终分组:
  + 基础信息: 2列
  + 步骤1 XXX: 8列
  + 步骤2 XXX: 8列
  ...

=== 列分组完成 ===
Final column groups summary: [...]
```

### 第2步：检查后端步骤映射

从控制台日志中找到 `stepAlgorithmOutputs` 的内容：

```javascript
{
  "1": Set(8) {"防洪治洪能力权重", "公众应急能力权重", ...},
  "2": Set(8) {"防洪治洪能力正理想解", "防洪治洪能力负理想解", ...},
  ...
}
```

**检查点**：
1. ✅ 是否包含所有步骤（1, 2, 3, 4, 5）？
2. ✅ 每个步骤的输出参数数量是否正确？
3. ✅ 输出参数名称是否与实际列名完全匹配？

### 第3步：检查实际的列名

从控制台日志中找到 `allColumnsList`：

```javascript
[
  {prop: "regionCode", label: "地区代码"},
  {prop: "regionName", label: "地区名称"},
  {prop: "防洪治洪能力权重", label: "防洪治洪能力权重"},
  ...
]
```

**对比步骤2的结果**：
- 后端配置的 `outputParam` 是否与 `prop` 完全匹配？
- 注意：必须**完全一致**（区分大小写、空格、标点符号）

### 第4步：定位问题

根据日志输出，可以判断问题所在：

#### 问题A：某个步骤没有匹配到列

**日志特征**：
```
步骤 1 的输出参数: ["xxx", "yyy"]
✗ 步骤1 没有匹配到任何列
```

**原因**：
- 后端配置的 `outputParam` 与实际列名不匹配
- 该步骤的算法配置信息缺失

**解决方法**：
1. 检查模型管理 > 配置 > 算法配置
2. 确认每个算法的 `outputParam` 字段正确设置
3. 确保 `outputParam` 与后端返回的列名（`prop`）完全一致

#### 问题B：列被错误地分到其他步骤

**日志特征**：
```
步骤 3 的输出参数: [...]
  ✓ 匹配: 某列 -> 步骤3
步骤 4 的输出参数: [...]
  ✓ 匹配: 某列 -> 步骤4  <-- 这列本应属于步骤3
```

**原因**：
- 多个步骤配置了相同的 `outputParam`
- `outputParam` 配置错误

**解决方法**：
1. 检查是否有重复的 `outputParam` 配置
2. 确认每个列只属于一个步骤

#### 问题C：列被关键字兜底分组错误归类

**日志特征**：
```
开始关键字兜底分组
未分配的列（40）: [...]
  ✓ 关键字匹配[优劣解算]: 某权重列 (某权重列)  <-- 错误
```

**原因**：
- 后端步骤映射不完整
- 列名包含多个关键字，被错误识别

**解决方法**：
1. **优先方案**：完善后端步骤映射配置
2. 调整关键字识别规则（见下文）

## 解决方案

### 方案1：修复后端配置（推荐）

1. **访问模型详情接口**：
   ```
   GET http://localhost:8081/api/model-management/models/3/detail
   ```

2. **检查返回的步骤配置**：
   ```json
   {
     "steps": [
       {
         "stepOrder": 1,
         "stepName": "定权",
         "description": "...|ALGORITHMS|[{\"outputParam\":\"防洪治洪能力权重\"}]"
       }
     ]
   }
   ```

3. **更新算法配置**：
   - 进入：模型管理 > 选择模型 > 配置 > 算法配置
   - 为每个算法正确设置 `outputParam` 字段
   - 确保 `outputParam` 与后端返回的列名完全一致

**示例**：
```
步骤1的算法：
- 算法1：outputParam = "防洪治洪能力权重"
- 算法2：outputParam = "公众应急能力权重"
- 算法3：outputParam = "财政负荷入能力权重"
...共8个

步骤2的算法：
- 算法1：outputParam = "防洪治洪能力正理想解"
- 算法2：outputParam = "防洪治洪能力负理想解"
...共8个
```

### 方案2：调整关键字识别规则

如果后端配置修复困难，可以临时调整关键字规则：

**编辑文件**：`frontend/src/components/ResultDialog.vue`

**找到第 340-343 行**：
```typescript
// 中文步骤识别规则：定权/优劣解算/分级/指标计算
const reWeighting = /(权重|权重值|权重系数)/
const reVikor = /(贴近度|理想解|距离|优劣)/
const reGrading = /(分级|等级|类别)/
const reIndicator = /(能力|评分|指数)/
```

**根据实际列名调整**，例如：
```typescript
// 更精确的匹配规则
const reWeighting = /权重$/  // 仅匹配以"权重"结尾的列
const reVikor = /(正理想解|负理想解|正距离|负距离|贴近度)/
const reGrading = /(分级结果|能力等级)/
const reIndicator = /能力指数$/
```

**注意**：这只是临时方案，建议优先修复后端配置。

## 常见问题

### Q1: 为什么步骤3是16列但分成了两张表？

**A**: 步骤3可能使用了双表格显示模式（`isDualTable: true`）。检查：
1. 后端返回的数据结构是否包含 `isDualTable` 标志
2. `table1Columns` 和 `table2Columns` 的列数总和是否为16

### Q2: 如何验证配置是否正确？

**A**: 运行以下检查：
1. 打开模型详情接口，确认算法配置
2. 点击"查看结果"，查看控制台日志
3. 对比 `stepAlgorithmOutputs` 与 `allColumnsList`
4. 确认每个步骤的匹配列数是否符合预期

### Q3: 修改后端配置后需要刷新页面吗？

**A**: 是的。修改模型配置后：
1. 刷新浏览器页面
2. 重新打开评估计算页面
3. 重新执行步骤查看结果

## 验证方法

修复后，验证步骤：

1. ✅ 步骤1应显示8列
2. ✅ 步骤2应显示8列
3. ✅ 步骤3应显示16列（可能分为两个折叠面板）
4. ✅ 步骤4应显示8列
5. ✅ 步骤5应显示8列
6. ✅ 基础信息应显示2列（地区代码、地区名称）
7. ✅ "其他输出"分组应该为空或仅包含极少数列

**控制台验证**：
```
=== 列分组完成 ===
Final column groups summary: [
  {key: 'base', name: '基础信息', columnCount: 2, columns: [...]},
  {key: 'step_1', name: '步骤1 定权', columnCount: 8, columns: [...]},
  {key: 'step_2', name: '步骤2 优劣解算', columnCount: 8, columns: [...]},
  {key: 'step_3', name: '步骤3 XXX', columnCount: 16, columns: [...]},
  {key: 'step_4', name: '步骤4 XXX', columnCount: 8, columns: [...]},
  {key: 'step_5', name: '步骤5 XXX', columnCount: 8, columns: [...]}
]
```

## 技术细节

### 列分组逻辑流程

```
1. 提取基础列（regionCode, regionName）
   ↓
2. 使用后端步骤映射分组
   - 从模型详情获取 stepAlgorithmOutputs
   - 按步骤顺序(1,2,3,4,5)遍历
   - 匹配 outputParam 与 列prop
   ↓
3. 关键字兜底分组
   - 定权：包含"权重"等关键字
   - 优劣解算：包含"贴近度"、"理想解"等
   - 分级：包含"分级"、"等级"等
   - 指标计算：包含"能力"、"指数"等
   ↓
4. 未匹配列归入"其他输出"
```

### 优先级

1. **最高优先级**：基础列（regionCode, regionName）
2. **次高优先级**：后端步骤映射
3. **兜底优先级**：关键字匹配
4. **最低优先级**：其他输出

---

**更新日期**: 2025年
**相关文件**: `frontend/src/components/ResultDialog.vue`
