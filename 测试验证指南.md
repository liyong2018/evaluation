# 测试验证指南

## 已完成的修改

### ✅ 后端修改（已完成）
- 添加了必要的 import 语句（`Arrays`, `Collections`）
- 在 `executeAlgorithmStep` 方法中添加了生成 `columns` 数组的逻辑
- 添加了 `generateColumnsWithStepOrder` 辅助方法

### ✅ 前端修改（已完成）
- 修改了 `ResultDialog.vue`，确保保留从后端接收的 `stepOrder` 字段

## 测试步骤

### 1. 重新编译后端

在后端项目根目录执行：

```bash
# 方式1: 使用 Maven
mvn clean compile

# 方式2: 如果使用 IDEA，直接 Build -> Rebuild Project
```

### 2. 重启后端服务

- 如果使用命令行：停止当前进程（Ctrl+C），然后重新运行
- 如果使用 IDEA：点击停止按钮，然后重新运行

### 3. 测试前端功能

1. **打开浏览器开发者工具**（按 F12）
2. **进入"控制台"（Console）标签页**
3. **导航到评估管理页面**
4. **执行算法步骤**：
   - 选择一个模型
   - 选择地区
   - 点击"执行算法步骤"
   - 查看"计算结果"弹窗

### 4. 验证后端日志

后端控制台应该输出类似以下的日志：

```
INFO  - 执行算法步骤, algorithmId=1, stepOrder=1, regionCodes.size=3
INFO  - 开始生成 columns 数组，步骤序号: 1, 列数: 10
DEBUG - 列 队伍管理能力计算 标记为步骤 1
DEBUG - 列 风险评估能力计算 标记为步骤 1
DEBUG - 列 财政投入能力计算 标记为步骤 1
DEBUG - 列 物资储备能力计算 标记为步骤 1
DEBUG - 列 医疗保障能力计算 标记为步骤 1
DEBUG - 列 自救互救能力计算 标记为步骤 1
DEBUG - 列 公众避险能力计算 标记为步骤 1
DEBUG - 列 转移安置能力计算 标记为步骤 1
INFO  - 完成 columns 数组生成，共 10 列，其中 8 列包含 stepOrder
INFO  - 算法步骤 1 执行完成，生成 3 行表格数据
```

**关键点**：
- ✅ 看到"开始生成 columns 数组"
- ✅ 看到"列 xxx 标记为步骤 1"（8条）
- ✅ 看到"完成 columns 数组生成，共 10 列，其中 8 列包含 stepOrder"

### 5. 验证前端日志

浏览器控制台应该输出类似以下的日志：

```
=== 开始计算列分组 ===
Computing column groups with: {
  allColumnsCount: 10,
  allColumnsList: [
    { prop: 'regionCode', label: '地区代码', stepOrder: undefined },
    { prop: 'regionName', label: '地区名称', stepOrder: undefined },
    { prop: '队伍管理能力计算', label: '队伍管理能力计算', stepOrder: 1 },
    { prop: '风险评估能力计算', label: '风险评估能力计算', stepOrder: 1 },
    { prop: '财政投入能力计算', label: '财政投入能力计算', stepOrder: 1 },
    { prop: '物资储备能力计算', label: '物资储备能力计算', stepOrder: 1 },
    { prop: '医疗保障能力计算', label: '医疗保障能力计算', stepOrder: 1 },
    { prop: '自救互救能力计算', label: '自救互救能力计算', stepOrder: 1 },
    { prop: '公众避险能力计算', label: '公众避险能力计算', stepOrder: 1 },
    { prop: '转移安置能力计算', label: '转移安置能力计算', stepOrder: 1 }
  ],
  ...
}

检测到列数据中包含stepOrder字段，使用该字段进行分组

  ✓ 列自带stepOrder: 队伍管理能力计算 -> 步骤1
  ✓ 列自带stepOrder: 风险评估能力计算 -> 步骤1
  ✓ 列自带stepOrder: 财政投入能力计算 -> 步骤1
  ✓ 列自带stepOrder: 物资储备能力计算 -> 步骤1
  ✓ 列自带stepOrder: 医疗保障能力计算 -> 步骤1
  ✓ 列自带stepOrder: 自救互救能力计算 -> 步骤1
  ✓ 列自带stepOrder: 公众避险能力计算 -> 步骤1
  ✓ 列自带stepOrder: 转移安置能力计算 -> 步骤1

✓ 添加分组(从列数据): 步骤1 评估指标赋值 共 8 列

=== 列分组完成 ===
Final column groups summary: [
  { key: 'base', name: '基础信息', columnCount: 2, columns: ['regionCode', 'regionName'] },
  { key: 'step_1', name: '步骤1 评估指标赋值', columnCount: 8, columns: [...] }
]
```

**关键点**：
- ✅ 每个输出列都有 `stepOrder: 1`
- ✅ 检测到"检测到列数据中包含stepOrder字段"
- ✅ 8个列都标记为"步骤1"
- ✅ 最终分组只有"基础信息"（2列）和"步骤1 评估指标赋值"（8列）
- ❌ **不应该出现"其他输出"分组**

### 6. 验证UI显示

在"计算结果"弹窗的列选择器中，应该看到：

```
☑ 基础信息 (2)
  ☑ 地区代码
  ☑ 地区名称

☑ 步骤1 评估指标赋值 (8)
  ☑ 队伍管理能力计算
  ☑ 风险评估能力计算
  ☑ 财政投入能力计算
  ☑ 物资储备能力计算
  ☑ 医疗保障能力计算
  ☑ 自救互救能力计算
  ☑ 公众避险能力计算
  ☑ 转移安置能力计算
```

**验证点**：
- ✅ "步骤1 评估指标赋值"分组显示 8 列
- ❌ **不应该有"其他输出"分组，或者"其他输出"为空**

## 常见问题排查

### 问题1：后端编译失败

**可能原因**：缺少必要的 import 语句

**解决方案**：确认文件开头有以下 import：
```java
import java.util.Arrays;
import java.util.Collections;
```

### 问题2：前端仍然显示"其他输出"

**可能原因A**：后端代码未生效（未重启）

**解决方案**：
1. 确认后端已重新编译
2. 确认后端已重启
3. 清除浏览器缓存（Ctrl+Shift+R）

**可能原因B**：后端返回的数据中没有 `columns` 字段

**解决方案**：
1. 在浏览器开发者工具的"网络"（Network）标签页中
2. 找到执行算法的API请求（通常是 `/api/evaluation/algorithm/.../step/.../execute`）
3. 查看响应数据，确认包含 `columns` 字段
4. 确认 `columns` 数组中的每个对象都有 `stepOrder` 字段

### 问题3：前端日志显示 `stepOrder: undefined`

**可能原因**：前端代码未保留 `stepOrder` 字段

**解决方案**：
检查 `ResultDialog.vue` 文件第697-702行：
```typescript
allColumns.value = columnsFromProps.map(col => ({
  prop: col.prop,
  label: col.label || getColumnLabel(col.prop),
  width: col.width || getColumnWidth(col.prop),
  formatter: col.formatter,
  stepOrder: (col as any).stepOrder  // 必须有这一行
}))
```

### 问题4：后端日志没有输出

**可能原因**：日志级别设置过高

**解决方案**：
检查 `application.yml` 或 `application.properties`，确保日志级别为 INFO 或 DEBUG：
```yaml
logging:
  level:
    com.evaluate: DEBUG
```

## 成功的标志

修复成功后，您应该看到：

1. ✅ **后端日志**：明确显示生成了 columns 数组，并标记了 stepOrder
2. ✅ **前端日志**：检测到 stepOrder 字段，使用该字段进行分组
3. ✅ **UI显示**：步骤1的8个列正确显示在"步骤1 评估指标赋值"分组中
4. ✅ **无"其他输出"**：不再出现包含大量列的"其他输出"分组

## 下一步

如果一切正常，可以继续测试其他步骤（步骤2、步骤3等），确认它们的列也能正确分组。

如果遇到问题，请提供：
1. 后端控制台的完整日志
2. 浏览器控制台的完整日志
3. 网络请求的响应数据（JSON格式）
