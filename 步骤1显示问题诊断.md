# 步骤1的13列显示问题诊断

## 问题现象

前端显示"基础信息 (2列)"，但点开后是空的，步骤1的13个字段没有显示。

## 可能的原因

### 1. 后端服务没有重启 ⚠️

**最可能的原因！**

- 数据库配置已更新
- 但后端服务还在使用旧的配置或缓存
- 必须重启后端服务才能加载新配置

**解决方法**：
```bash
# 停止后端服务
# 重新启动后端服务
```

### 2. stepOutputParams没有正确记录

**检查方法**：
查看后端日志，搜索：
```
步骤1 的输出参数:
```

**预期日志**：
```
步骤1 的输出参数: [是否有社区（行政村）应急预案, 是否有本辖区弱势人群清单, ...]
```

**如果日志显示输出参数为空或数量不对**：
- 检查 `executeStep` 方法是否正确执行了所有13个算法
- 检查 `outputToAlgorithmName` 映射是否正确生成

### 3. 前端列分组逻辑问题

**检查方法**：
使用浏览器开发者工具查看API返回的原始数据：
1. 打开浏览器开发者工具（F12）
2. 切换到Network标签
3. 执行模型8
4. 找到 `/api/model/execute` 请求
5. 查看Response

**检查点**：
- `tableData[0]` 是否包含所有13个字段？
- `columns` 数组是否包含所有13列的配置？
- 每列的 `stepOrder` 是否正确设置为1？

### 4. 数据库配置未生效

**检查方法**：
```sql
SELECT algorithm_order, algorithm_name, output_param 
FROM step_algorithm 
WHERE step_id = 50 
ORDER BY algorithm_order;
```

**预期结果**：
应该看到13行，algorithm_name都是中文，output_param都是大写的英文字段名。

## 诊断步骤

### 步骤1：确认数据库配置
```sql
SELECT COUNT(*) as count FROM step_algorithm WHERE step_id = 50;
-- 应该返回 13

SELECT algorithm_order, algorithm_name, output_param 
FROM step_algorithm 
WHERE step_id = 50 
ORDER BY algorithm_order;
-- 应该看到13行正确的配置
```

### 步骤2：重启后端服务
**这是最重要的一步！**

停止并重新启动后端服务，确保加载最新的数据库配置。

### 步骤3：查看后端日志
启动后端服务后，执行模型8，查看日志：

**关键日志**：
```
执行步骤: XXX - 社区指标计算, order=1
步骤1 的输出参数: [是否有社区（行政村）应急预案, ...]
步骤 XXX 执行完成
```

**如果看到**：
- "步骤1 的输出参数: []" - 说明 `outputToAlgorithmName` 为空
- 没有看到这行日志 - 说明步骤1没有执行或执行失败

### 步骤4：使用测试脚本
```powershell
.\debug_step1_output.ps1
```

**检查输出**：
1. tableData第一行应该有多少个字段？
2. columns数组应该有多少列？
3. stepResults中步骤1的outputToAlgorithmName有多少个？

### 步骤5：检查前端
如果后端数据正确，但前端显示不对：

1. 清除浏览器缓存
2. 刷新页面
3. 检查前端的列分组逻辑
4. 检查是否有JavaScript错误

## 快速修复清单

- [ ] 1. 确认数据库配置正确（13个算法，中文名称）
- [ ] 2. **重启后端服务**（最重要！）
- [ ] 3. 清除浏览器缓存
- [ ] 4. 执行模型8
- [ ] 5. 查看后端日志
- [ ] 6. 使用debug_step1_output.ps1检查返回数据
- [ ] 7. 使用浏览器开发者工具检查API响应

## 预期结果

### 后端日志应该显示
```
执行步骤: XXX - 社区指标计算, order=1
执行算法: XXX - 是否有社区（行政村）应急预案
执行算法: XXX - 是否有本辖区弱势人群清单
...（共13个算法）
步骤1 的输出参数: [是否有社区（行政村）应急预案, 是否有本辖区弱势人群清单, ...]
步骤 XXX 执行完成
```

### API返回数据应该包含
```json
{
  "tableData": [
    {
      "regionCode": "...",
      "regionName": "...",
      "是否有社区（行政村）应急预案": 1.0,
      "是否有本辖区弱势人群清单": 1.0,
      ...（共13个字段）
    }
  ],
  "columns": [
    {"label": "regionCode", ...},
    {"label": "regionName", ...},
    {"label": "是否有社区（行政村）应急预案", "stepOrder": 1, ...},
    ...（共15列：2个基础列 + 13个步骤1的列）
  ]
}
```

### 前端应该显示
```
基础信息 (2列)
  - regionCode
  - regionName

步骤1 社区指标计算 (13列)
  - 是否有社区（行政村）应急预案
  - 是否有本辖区弱势人群清单
  - ...（共13列）
```

## 常见错误

### 错误1：忘记重启后端服务
**症状**：数据库配置已更新，但前端还是显示旧的数据

**解决**：重启后端服务

### 错误2：浏览器缓存
**症状**：后端已更新，但前端还是显示旧的界面

**解决**：清除浏览器缓存，或使用隐私模式

### 错误3：步骤1执行失败
**症状**：后端日志显示步骤1执行失败或没有输出

**解决**：
1. 检查数据库中是否有测试数据
2. 检查算法表达式是否正确
3. 检查字段名是否与数据库表字段匹配

## 下一步

1. **立即重启后端服务**
2. 执行 `debug_step1_output.ps1` 查看返回数据
3. 如果还是不对，提供：
   - 后端日志（特别是步骤1执行的部分）
   - `debug_step1_output.ps1` 的输出
   - 浏览器开发者工具中的API响应
