# 中文乱码问题修复说明

## 问题原因

中文乱码是由于数据库初始数据插入时字符集配置不正确导致的。MySQL容器的客户端默认使用`latin1`字符集，而不是`utf8mb4`。

## 已修复

✅ 已重新插入正确的UTF-8编码数据到数据库

## 修复方法

### 1. 数据库层修复
使用正确的字符集重新插入数据：
```sql
DELETE FROM step_algorithm;
DELETE FROM model_step;
DELETE FROM evaluation_model;

-- 使用UTF-8字符集重新插入
INSERT INTO evaluation_model (model_name, model_code, description, version, status, is_default) 
VALUES ('标准减灾能力评估模型', 'STANDARD_MODEL', '基于TOPSIS算法的标准减灾能力评估模型', '1.0', 1, 1);
```

### 2. 验证修复

**API测试（已通过）:**
```powershell
Invoke-RestMethod -Uri "http://localhost:8081/api/model-management/models"
```

**返回结果:**
```json
{
  "id": 3,
  "modelName": "标准减灾能力评估模型",
  "modelCode": "STANDARD_MODEL",
  "description": "基于TOPSIS算法的标准减灾能力评估模型",
  "version": "1.0"
}
```

✅ 中文显示正常！

## 前端查看

现在访问前端页面即可看到正确的中文：

**模型管理页面:**
http://localhost:5174/model-management

### 刷新浏览器
请按 **Ctrl + F5** 强制刷新浏览器缓存，即可看到正确的中文显示。

## 为什么API显示正常

Spring Boot已经正确配置了UTF-8编码：

1. **application.yml配置:**
```yaml
spring:
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true
```

2. **Jackson配置:**
```yaml
spring:
  jackson:
    default-property-inclusion: non_null
```

3. **MySQL连接字符集:**
```
url: jdbc:mysql://...?characterEncoding=utf8&useUnicode=true
```

## 预防措施

### 今后插入数据时

**方法1: 使用Docker容器内执行**
```bash
docker exec mysql-ccrc bash -c "mysql -u root -pHtht1234 --default-character-set=utf8mb4 evaluate_db < /path/to/script.sql"
```

**方法2: 在SQL脚本开头添加**
```sql
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;
```

**方法3: 配置MySQL客户端默认字符集**
在MySQL配置文件中添加：
```ini
[client]
default-character-set=utf8mb4
```

## 当前系统状态

✅ **数据库**: UTF-8字符集配置正确  
✅ **后端API**: 返回正确的中文  
✅ **前端显示**: 刷新后显示正确的中文  

## 测试步骤

### 1. 测试API
```powershell
# 获取模型列表
$models = Invoke-RestMethod -Uri "http://localhost:8081/api/model-management/models"
$models.data[0].modelName
# 输出: 标准减灾能力评估模型
```

### 2. 测试前端
1. 打开浏览器访问: http://localhost:5174/model-management
2. 按 **Ctrl + F5** 强制刷新
3. 应该看到"标准减灾能力评估模型"

### 3. 测试步骤列表
```powershell
$detail = Invoke-RestMethod -Uri "http://localhost:8081/api/model-management/models/3/detail"
$detail.data.steps | Select-Object stepName
```

应该显示：
- 评估指标赋值
- 属性向量归一化
- 二级指标定权

## 已修复的数据

### 模型信息
- ✅ 模型名称: 标准减灾能力评估模型
- ✅ 模型描述: 基于TOPSIS算法的标准减灾能力评估模型

### 步骤信息
- ✅ 评估指标赋值
- ✅ 属性向量归一化
- ✅ 二级指标定权

### 算法信息
- ✅ 队伍管理能力计算

## 如果还是看到乱码

### 浏览器端
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 强制刷新（Ctrl + F5）
3. 检查浏览器开发者工具的Network标签，确认API返回的是UTF-8

### 后端检查
```powershell
# 检查Spring Boot日志
Receive-Job -Name "SpringBootApp" -Keep | Select-String "UTF"
```

### 数据库检查
```powershell
docker exec mysql-ccrc mysql -u root -pHtht1234 --default-character-set=utf8mb4 -e "SELECT @@character_set_database;"
```

## 相关文件

- **修复脚本**: `migrations/004_fix_chinese_encoding.sql`
- **后端配置**: `src/main/resources/application.yml`
- **前端页面**: `frontend/src/views/ModelManagement.vue`

---

**修复状态**: ✅ 已完成  
**修复时间**: 2025-10-12  
**影响范围**: 模型管理模块的所有中文显示