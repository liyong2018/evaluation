# 快速开始 - 步骤分组列显示功能

## 📋 更新内容概述

本次更新为"查看所有步骤结果"功能页面添加了**按步骤分组的列显示/隐藏控制**，使其与单表格结果页面保持一致的用户体验。

## 🎯 核心改进

✅ 多步骤结果页面的列控制改为按步骤分组的折叠面板  
✅ 自动从模型配置获取步骤-算法输出参数映射关系  
✅ 支持关键字兜底分组（防洪治洪、公众应急等）  
✅ 可快速选择/取消整个步骤分组的列  
✅ 增加详细的调试日志便于问题排查  

## 📁 修改的文件

```
frontend/src/components/ResultDialog.vue
```

**修改点**：
1. UI层：将多步骤模式的列控制改为折叠面板
2. 逻辑层：多步骤模式也加载模型详情获取步骤映射
3. 增强：添加详细的控制台日志

## 🚀 如何使用

### 用户操作步骤

1. **打开评估计算页面**
   - 导航到：减灾能力评估系统 > 评估计算

2. **配置评估参数**
   - 填写评估名称
   - 选择权重配置
   - 选择评估模型
   - 选择评估算法
   - 选择地区

3. **查看所有步骤结果**
   - 在算法步骤区域找到"查看所有步骤结果"按钮（绿色按钮）
   - 点击该按钮

4. **在结果对话框中操作**
   - **选择步骤**：从下拉列表选择要查看的步骤
   - **展开分组**：点击折叠面板标题展开某个步骤分组
   - **快速操作**：
     - 点击"选择该组"按钮：选中该步骤的所有列
     - 点击"取消该组"按钮：取消选中该步骤的列（保留基础列）
   - **精细控制**：逐个勾选/取消勾选列
   - **全局操作**：
     - "全选"：选中所有列
     - "取消全选"：仅保留基础列（地区代码、地区名称）
     - "重置"：恢复默认状态

5. **查看结果**
   - 表格会根据您的列选择动态更新
   - 可以导出结果或生成专题图

## 🔧 开发者指南

### 调试方法

1. **打开浏览器开发者工具**
   - Chrome: F12 或 Ctrl+Shift+I
   - Firefox: F12 或 Ctrl+Shift+I

2. **切换到 Console 标签页**

3. **执行"查看所有步骤结果"操作**

4. **查看控制台日志**
   ```
   Loading model detail for modelId: 3
   Model steps received: 4
   Processing step 1: 多准则决策减灾能力评估模型-定权
   Step 1 algorithms: 2
   Step 1 output param: 乡镇减灾能力权重
   Step algorithm outputs map: {...}
   Computing column groups with: {...}
   Added dynamic step group: 步骤1 多准则决策减灾能力评估模型-定权 with 8 columns
   Final column groups: [...]
   ```

### 关键代码位置

#### 1. 模型详情加载
**位置**: `ResultDialog.vue` 第 613-670 行

```typescript
const loadModelDetail = async (modelId: number) => {
  // 加载模型详情
  // 解析步骤-算法输出参数映射
  // 存储到 stepAlgorithmOutputs 和 stepOrderNames
}
```

#### 2. 列分组计算
**位置**: `ResultDialog.vue` 第 351-422 行

```typescript
const columnGroups = computed<ColumnGroup[]>(() => {
  // 1. 提取基础列
  // 2. 根据后端步骤映射分组
  // 3. 关键字兜底分组
  // 4. 组装最终结果
})
```

#### 3. UI 渲染
**位置**: `ResultDialog.vue` 第 24-78 行

```vue
<div class="column-control" v-if="currentStepData">
  <el-collapse>
    <el-collapse-item v-for="group in columnGroups">
      <!-- 分组内容 -->
    </el-collapse-item>
  </el-collapse>
</div>
```

### API 依赖

**模型详情接口**:
```
GET /api/model-management/models/{modelId}/detail
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "id": 3,
    "modelName": "多准则决策减灾能力评估模型",
    "steps": [
      {
        "id": 1,
        "stepOrder": 1,
        "stepName": "定权",
        "description": "步骤描述|ALGORITHMS|[{\"outputParam\":\"weight1\"}]"
      }
    ]
  }
}
```

## 🐛 故障排查

### 问题1: 没有看到步骤分组

**可能原因**:
- modelId 没有传递给 ResultDialog
- 模型详情接口返回失败

**解决方法**:
1. 检查控制台是否有错误日志
2. 确认 modelId 是否正确传递
3. 验证模型详情接口是否正常

### 问题2: 分组名称显示为"步骤1"而不是完整名称

**可能原因**:
- 模型步骤的 stepName 字段为空
- description 字段中没有算法配置信息

**解决方法**:
1. 检查数据库中模型步骤配置
2. 确认 stepName 字段有值
3. 使用关键字兜底分组作为补充

### 问题3: 某些列没有被分组

**可能原因**:
- 列名不匹配后端配置的 outputParam
- 列名不匹配关键字识别规则

**解决方法**:
1. 检查算法配置中的 outputParam 是否正确
2. 查看控制台日志中的 "Final column groups"
3. 考虑添加新的关键字识别规则

## 📝 配置说明

### 关键字识别规则

系统使用以下正则表达式识别列：

```typescript
// 定权步骤
const reWeighting = /(权重|权重值|权重系数)/

// 优劣解算步骤
const reVikor = /(贴近度|理想解|距离|优劣)/

// 分级步骤
const reGrading = /(分级|等级|类别)/

// 指标计算步骤
const reIndicator = /(能力|评分|指数)/
```

如需调整，修改 `ResultDialog.vue` 第 340-343 行。

### 算法输出参数配置

在模型管理 > 配置 > 算法配置中，确保每个算法的 `outputParam` 字段正确设置。

**示例**:
```json
{
  "algorithmCode": "AHP_WEIGHT_CALC",
  "outputParam": "乡镇减灾能力权重"
}
```

## 🔄 版本兼容性

- ✅ 向后兼容：即使模型详情加载失败，也会使用关键字分组
- ✅ 无需数据库迁移：利用现有的模型配置结构
- ✅ 渐进增强：有步骤映射时使用映射，没有时使用关键字

## 📚 相关文档

- [详细更新说明](./更新说明-步骤分组列显示.md)
- [UI对比文档](./UI对比-步骤分组列显示.md)

## 🎉 预期效果

更新后，用户在查看所有步骤结果时：

1. **更清晰**：知道每列数据来自哪个步骤
2. **更高效**：可以按步骤快速选择列
3. **更一致**：多步骤和单表格模式UI统一
4. **更智能**：自动识别和分组列

---

**开发团队**: 减灾能力评估系统开发组  
**更新日期**: 2025年  
**版本**: v1.0
