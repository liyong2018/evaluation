# 关键字匹配优化 - 临时方案

## 问题说明

虽然模型配置中有每个步骤的 `outputParam`（英文），但实际返回的列名是中文，导致无法匹配。

**示例**：
- 配置的 `outputParam`: `teamManagementNorm`
- 实际的列名: `队伍管理能力归一化`
- 结果：无法匹配 ❌

## 临时解决方案

优化关键字识别规则，使其更精确地匹配各个步骤的列。

### 修改内容

**文件**: `frontend/src/components/ResultDialog.vue`

#### 1. 更新关键字识别规则（第339-343行）

**修改前**：
```typescript
const reWeighting = /(权重|权重值|权重系数)/
const reVikor = /(贴近度|理想解|距离|优劣)/
const reGrading = /(分级|等级|类别)/
const reIndicator = /(能力|评分|指数)/
```

**修改后**：
```typescript
const reNormalization = /归一化$/  // 步骤2: 属性向量归一化
const reWeighting = /定权$/        // 步骤3: 二级指标定权
const reIdealSolution = /(优解|差解)$/  // 步骤4: 优劣解计算
const reScoreAndGrade = /(值|分级)$/   // 步骤5: 能力值计算与分级
```

**说明**：
- 使用 `$` 结尾匹配，更精确
- 根据实际的列名特征设计规则
- 每个规则对应一个具体步骤

#### 2. 更新匹配函数（第345-349行）

**修改前**：
```typescript
const isWeighting = (c: ColumnItem) => reWeighting.test(String(c.label)) || /weight/i.test(c.prop)
const isVikor = (c: ColumnItem) => reVikor.test(String(c.label)) || /(closeness|ideal|distance)/i.test(c.prop)
const isGrading = (c: ColumnItem) => reGrading.test(String(c.label)) || /(grade|level|category)/i.test(c.prop)
const isIndicator = (c: ColumnItem) => reIndicator.test(String(c.label)) || /(ability|score|index)/i.test(c.prop)
```

**修改后**：
```typescript
const isNormalization = (c: ColumnItem) => reNormalization.test(String(c.label)) || reNormalization.test(c.prop)
const isWeighting = (c: ColumnItem) => reWeighting.test(String(c.label)) || reWeighting.test(c.prop)
const isIdealSolution = (c: ColumnItem) => reIdealSolution.test(String(c.label)) || reIdealSolution.test(c.prop)
const isScoreAndGrade = (c: ColumnItem) => reScoreAndGrade.test(String(c.label)) || reScoreAndGrade.test(c.prop)
```

#### 3. 更新分组逻辑（第444-520行）

将模糊的 `g1, g2, g3, g4` 改为明确的 `step2, step3, step4, step5`，并按正确的步骤顺序组装。

### 预期效果

修改后，控制台日志应该显示：

```
=== 开始计算列分组 ===

基础列: regionCode
基础列: regionName

列数据中没有stepOrder，使用后端步骤映射: [1, 2, 3, 4, 5]
✗ 步骤1 没有匹配到任何列
✗ 步骤2 没有匹配到任何列
...

开始关键字兜底分组
未分配的列（48）: [...]
  ✓ 关键字匹配[步骤2-归一化]: 队伍管理能力归一化 (队伍管理能力归一化)
  ✓ 关键字匹配[步骤2-归一化]: 风险评估能力归一化 (风险评估能力归一化)
  ...共8列
  
  ✓ 关键字匹配[步骤3-定权]: 队伍管理能力定权 (队伍管理能力定权)
  ✓ 关键字匹配[步骤3-定权]: 风险评估能力定权 (风险评估能力定权)
  ...共16列
  
  ✓ 关键字匹配[步骤4-优劣解]: 灾害管理能力优解 (灾害管理能力优解)
  ✓ 关键字匹配[步骤4-优劣解]: 灾害管理能力差解 (灾害管理能力差解)
  ...共8列
  
  ✓ 关键字匹配[步骤5-值与分级]: 灾害管理能力值 (灾害管理能力值)
  ✓ 关键字匹配[步骤5-值与分级]: 灾害管理能力分级 (灾害管理能力分级)
  ...共8列

组装最终分组:
  + 基础信息: 2列
  + 步骤2 属性向量归一化(关键字): 8列
  + 步骤3 二级指标定权(关键字): 16列
  + 步骤4 优劣解计算(关键字): 8列
  + 步骤5 能力值计算与分级(关键字): 8列

=== 列分组完成 ===
Final column groups summary: [
  {key: 'base', name: '基础信息', columnCount: 2},
  {key: 'step_2', name: '步骤2 属性向量归一化', columnCount: 8},
  {key: 'step_3', name: '步骤3 二级指标定权', columnCount: 16},
  {key: 'step_4', name: '步骤4 优劣解计算', columnCount: 8},
  {key: 'step_5', name: '步骤5 能力值计算与分级', columnCount: 8}
]
```

### 列分布验证

根据您的说明，应该是：
- ✅ 步骤1：0列（没有显示）
- ✅ 步骤2：8列（归一化）
- ✅ 步骤3：16列（定权 + 综合定权）
- ✅ 步骤4：8列（优解 + 差解）
- ✅ 步骤5：8列（值 + 分级）
- ✅ 总计：2（基础）+ 8 + 16 + 8 + 8 = 42列

**注意**：如果总共是50列，可能还有其他列（如原始数据列），这些会归入"其他输出"或根据其他规则匹配。

## 优点

1. ✅ 无需修改后端
2. ✅ 根据实际列名特征精确匹配
3. ✅ 按正确的步骤顺序显示
4. ✅ 显示正确的步骤名称

## 缺点

1. ⚠️ 仍然是基于关键字，不如后端直接提供 `stepOrder` 可靠
2. ⚠️ 如果列名格式变化，需要调整规则
3. ⚠️ 步骤1的列无法识别（因为没有明显的关键字特征）

## 最佳方案（仍然推荐）

**后端在返回的 `columns` 数组中添加 `stepOrder` 字段**

这样可以：
- ✅ 100% 准确
- ✅ 支持所有步骤（包括步骤1）
- ✅ 不依赖列名格式
- ✅ 支持国际化

## 测试验证

1. 刷新浏览器页面
2. 点击单个步骤的"查看结果"按钮
3. 查看控制台日志
4. 检查列分组是否正确：
   - 步骤2：8列（归一化）
   - 步骤3：16列（定权）
   - 步骤4：8列（优劣解）
   - 步骤5：8列（值与分级）

## 如果还有问题

如果某些列仍然分组不正确，请：

1. 查看控制台的 `未分配的列` 日志
2. 检查这些列的名称特征
3. 调整对应的正则表达式规则

**示例调整**：
```typescript
// 如果"综合定权"的列被错误分类
const reWeighting = /(定权|综合定权)$/  // 包含更多变体

// 如果某些列名不是以关键字结尾
const reNormalization = /归一化/  // 移除 $ 使其匹配包含"归一化"的列
```

---

**更新日期**: 2025年  
**方案类型**: 临时解决方案（推荐后端添加 stepOrder 字段）  
**修改文件**: `frontend/src/components/ResultDialog.vue`
