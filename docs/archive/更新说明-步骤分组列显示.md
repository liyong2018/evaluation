# 评估结果页面步骤分组列显示功能更新说明

## 更新概述

本次更新为"查看所有步骤结果"页面添加了按步骤分组的列显示/隐藏功能，参考了单表格结果页面的实现。

## 主要更改

### 1. 文件修改
- **文件**: `frontend/src/components/ResultDialog.vue`
- **修改内容**: 

#### a) UI更新 - 多步骤模式的列控制面板
将原有的简单复选框列表改为分组折叠面板（el-collapse），与单表格模式保持一致：

```vue
<!-- 列显示/隐藏控制（按步骤分组） -->
<div class="column-control" v-if="currentStepData">
  <h4>列显示控制</h4>
  <!-- 分组折叠面板 -->
  <el-collapse>
    <el-collapse-item
      v-for="group in columnGroups"
      :key="group.key"
      :title="`${group.name}（${group.columns.length}列）`"
    >
      <div class="group-actions">
        <el-button size="small" @click="selectGroupColumns(group.key)">选择该组</el-button>
        <el-button size="small" @click="unselectGroupColumns(group.key)">取消该组</el-button>
      </div>
      <div class="column-checkboxes">
        <el-checkbox-group v-model="visibleColumns">
          <el-checkbox 
            v-for="column in group.columns" 
            :key="column.prop"
            :label="column.prop"
            :disabled="column.prop === 'regionCode' || column.prop === 'regionName'"
          >
            {{ column.label }}
          </el-checkbox>
        </el-checkbox-group>
      </div>
    </el-collapse-item>
  </el-collapse>
  <div class="column-actions">
    <el-button size="small" @click="selectAllColumns">全选</el-button>
    <el-button size="small" @click="unselectAllColumns">取消全选</el-button>
    <el-button size="small" @click="resetColumns">重置</el-button>
  </div>
</div>
```

#### b) 逻辑更新 - 模型详情加载
- 为多步骤模式也加载模型详情，以获取步骤-算法输出参数映射
- 增加了详细的控制台日志，便于调试

```typescript
// 监听props变化时，无论单表格还是多步骤模式都加载模型详情
if (props.modelId) {
  loadModelDetail(props.modelId)
} else {
  // 如果没有modelId，直接初始化列
  initializeColumns()
}
```

#### c) 增强 loadModelDetail 函数
- 添加详细的控制台日志输出
- 错误处理优化：即使加载失败也会初始化列

```typescript
const loadModelDetail = async (modelId: number) => {
  try {
    console.log('Loading model detail for modelId:', modelId)
    const resp = await modelManagementApi.getModelDetail(modelId)
    if (resp?.success) {
      const steps = resp.data?.steps || []
      // ... 解析步骤算法输出参数
      console.log('Step algorithm outputs map:', outputsMap)
      console.log('Step order names map:', namesMap)
    }
  } catch (error: any) {
    console.warn('加载模型详情失败，使用关键字分组作为回退: ', error?.message || error)
    // 即使失败也要初始化列
    initializeColumns()
  }
}
```

#### d) 增强 columnGroups 计算属性
- 添加详细的日志输出，便于调试列分组逻辑
- 该计算属性已支持单表格和多步骤两种模式

```typescript
const columnGroups = computed<ColumnGroup[]>(() => {
  console.log('Computing column groups with:', {
    allColumnsCount: allColumns.value.length,
    stepAlgorithmOutputs: stepAlgorithmOutputs.value,
    stepOrderNames: stepOrderNames.value,
    isMultiStep: props.resultData?.isMultiStep
  })
  
  // 1. 基础列（地区代码、地区名称）
  // 2. 后端步骤输出分组（根据模型配置的算法输出参数）
  // 3. 关键字兜底分组（根据列名关键字识别）
  
  console.log('Final column groups:', groups.map(g => 
    ({ key: g.key, name: g.name, columnCount: g.columns.length })
  ))
  
  return groups
})
```

## 功能特性

### 1. 后端步骤映射优先
系统会从模型详情接口获取每个步骤配置的算法输出参数，优先使用这些映射关系来分组列。

**API接口**: `GET /api/model-management/models/{modelId}/detail`

返回的步骤信息中，`description` 字段包含算法配置（JSON格式），格式如下：
```json
{
  "description": "步骤描述|ALGORITHMS|[{\"outputParam\":\"weight1\"},{\"outputParam\":\"weight2\"}]"
}
```

### 2. 关键字兜底分组
如果某些列没有被后端步骤映射覆盖，系统会使用关键字识别来分组：

- **步骤1 定权**: 包含"权重"、"权重值"、"权重系数"等关键字
- **步骤2 优劣解算**: 包含"贴近度"、"理想解"、"距离"、"优劣"等关键字
- **步骤3 分级**: 包含"分级"、"等级"、"类别"等关键字
- **步骤4 指标计算**: 包含"能力"、"评分"、"指数"等关键字
- **其他输出**: 未被分类的列

### 3. 用户交互功能
- **选择步骤**: 下拉选择要查看的算法步骤
- **展开/收起分组**: 点击折叠面板展开或收起列分组
- **选择该组**: 快速选中该分组下的所有列
- **取消该组**: 快速取消选中该分组下的所有列（保留基础列）
- **全选**: 选中所有列
- **取消全选**: 取消选中所有列（保留基础列：地区代码、地区名称）
- **重置**: 恢复到默认状态（所有列都显示）

## 使用流程

1. 在评估计算页面，配置好评估参数（模型、算法、地区等）
2. 在算法步骤区域，点击"查看所有步骤结果"按钮
3. 弹出结果对话框，显示所有步骤的计算结果
4. 使用步骤选择器切换不同步骤
5. 使用列显示控制面板按步骤分组管理列的显示/隐藏

## 技术实现要点

### 1. 步骤-算法输出映射获取
```typescript
// 从模型详情的steps中解析算法配置
steps.forEach((step: any) => {
  const order = Number(step.stepOrder ?? step.order ?? step.step_number ?? 0)
  namesMap[order] = step.stepName ?? step.name ?? ''
  
  let algos: any[] = []
  if (typeof step.description === 'string' && step.description.includes('|ALGORITHMS|')) {
    try {
      const json = step.description.split('|ALGORITHMS|')[1]
      algos = JSON.parse(json)
    } catch (_) {
      // ignore JSON parse error
    }
  }
  
  const outputs = new Set<string>()
  algos.forEach(a => {
    if (a?.outputParam) {
      outputs.add(String(a.outputParam))
    }
  })
  
  if (outputs.size > 0) {
    outputsMap[order] = outputs
  }
})
```

### 2. 列分组计算逻辑
```typescript
const columnGroups = computed<ColumnGroup[]>(() => {
  // 1. 提取基础列（地区信息）
  // 2. 根据后端步骤映射分组
  // 3. 对未分配的列使用关键字识别
  // 4. 组装最终分组结果
})
```

### 3. 多步骤与单表格模式共享逻辑
- `columnGroups` 计算属性同时支持两种模式
- `allColumns` 数组在两种模式下都被正确初始化
- `selectGroupColumns` / `unselectGroupColumns` 函数共享

## 调试信息

代码中增加了详细的控制台日志输出，便于排查问题：

1. **模型详情加载**: 显示模型ID、步骤数量、每个步骤的算法配置
2. **列分组计算**: 显示总列数、步骤映射、是否多步骤模式
3. **动态分组添加**: 显示每个分组的名称和列数
4. **最终分组结果**: 显示所有分组的汇总信息

在浏览器控制台可以看到类似以下的日志：
```
Loading model detail for modelId: 3
Model steps received: 4
Processing step 1: 多准则决策减灾能力评估模型-定权
Step 1 algorithms: 2
Step 1 output param: 乡镇减灾能力权重
Computing column groups with: {...}
Added dynamic step group: 步骤1 多准则决策减灾能力评估模型-定权 with 8 columns
Final column groups: [{key: 'base', name: '基础信息', columnCount: 2}, ...]
```

## 注意事项

1. **modelId 必传**: 在调用 ResultDialog 时需要传递 modelId prop，否则无法获取步骤映射
2. **算法配置格式**: 后端需要在步骤的 description 字段中按照约定格式存储算法配置
3. **兼容性**: 即使模型详情加载失败，系统也会使用关键字兜底分组，确保功能可用

## 后续优化建议

1. 考虑将步骤-算法映射独立存储，而不是嵌入在 description 字段中
2. 可以为用户提供自定义分组的功能
3. 考虑记住用户的列显示偏好设置（localStorage）

## 测试建议

1. 测试有模型ID的情况，验证步骤分组是否正确
2. 测试无模型ID的情况，验证关键字兜底分组是否生效
3. 测试模型详情接口失败的情况，验证错误处理是否正常
4. 测试选择/取消选择分组功能
5. 测试切换不同步骤时列分组是否正确更新
