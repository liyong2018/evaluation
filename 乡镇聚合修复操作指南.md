# 乡镇聚合修复操作指南

## 修复内容总结

### 问题
1. ❌ 步骤2没有真正按乡镇聚合，还是按社区统计
2. ❌ 步骤2的输出字段名与步骤3的输入字段名不匹配

### 解决方案
1. ✅ 在后端添加真正的乡镇聚合逻辑（`executeTownshipAggregation`方法）
2. ✅ 修改步骤2的输出字段名，使其与步骤3的输入字段名一致
3. ✅ 在 `generateResultTable` 中添加 `townshipName` 和 `communityName` 字段

## 操作步骤

### 步骤1：确认数据库修改已执行 ✅

已执行的SQL修改：
```sql
-- 修改步骤2的输出参数名称
UPDATE step_algorithm SET output_param = 'PLAN_CONSTRUCTION' WHERE id = 1752;
UPDATE step_algorithm SET output_param = 'HAZARD_INSPECTION' WHERE id = 1753;
UPDATE step_algorithm SET output_param = 'RISK_ASSESSMENT' WHERE id = 1754;
UPDATE step_algorithm SET output_param = 'FINANCIAL_INPUT' WHERE id = 1755;
UPDATE step_algorithm SET output_param = 'MATERIAL_RESERVE' WHERE id = 1756;
UPDATE step_algorithm SET output_param = 'MEDICAL_SUPPORT' WHERE id = 1757;
UPDATE step_algorithm SET output_param = 'SELF_MUTUAL_AID' WHERE id = 1758;
UPDATE step_algorithm SET output_param = 'PUBLIC_EVACUATION' WHERE id = 1759;
UPDATE step_algorithm SET output_param = 'RELOCATION_SHELTER' WHERE id = 1760;
```

验证：
```bash
mysql -h 192.168.15.203 -P 30314 -u root -p123456 evaluate_db -e "SELECT id, algorithm_name, output_param FROM step_algorithm WHERE step_id = 51 ORDER BY algorithm_order;"
```

### 步骤2：确认代码修改已完成 ✅

已修改的文件：
- `src/main/java/com/evaluate/service/impl/ModelExecutionServiceImpl.java`

修改内容：
1. 在 `executeModel` 方法中添加AGGREGATION类型的特殊处理
2. 添加 `executeTownshipAggregation` 方法实现乡镇聚合
3. 添加 `toDouble` 辅助方法
4. 在 `generateResultTable` 中添加 `townshipName` 和 `communityName` 字段

验证编译：
```bash
# 检查是否有编译错误
# 应该只有警告，没有错误
```

### 步骤3：重启后端服务 ⚠️

**重要：必须重启后端服务才能使代码修改生效！**

```bash
# 停止当前服务
# 方法1：如果使用IDE，点击停止按钮
# 方法2：如果使用命令行，按 Ctrl+C

# 重新启动服务
# 方法1：在IDE中点击运行按钮
# 方法2：使用命令行启动
```

### 步骤4：执行测试 🧪

#### 方法1：使用PowerShell测试脚本
```powershell
.\test_township_aggregation.ps1
```

#### 方法2：使用curl或Postman
```bash
POST http://localhost:8080/api/model/execute
Content-Type: application/json

{
  "modelId": 8,
  "regionCodes": ["511425108001", "511425108002", "511425108003"],
  "weightConfigId": 1
}
```

### 步骤5：验证结果 ✓

#### 检查点1：返回数据行数
- ✅ 应该返回1行数据（乡镇级别）
- ❌ 如果返回3行数据，说明没有聚合

#### 检查点2：字段名
- ✅ 应该包含：`Plan Construction`, `Hazard Inspection`, `Risk Assessment` 等
- ✅ 应该包含：`townshipName`, `communityName`
- ❌ 不应该包含：`TOWNSHIP_PLAN_AGG` 等旧字段名

#### 检查点3：数值
- ✅ 应该是3个社区的平均值
- 例如：如果3个社区的 `Plan Construction` 分别是 0.5, 0.6, 0.7
- 则乡镇的 `Plan Construction` 应该是 0.6 (平均值)

#### 检查点4：后端日志
查看后端日志，应该包含：
```
检测到乡镇聚合步骤，执行按乡镇分组聚合
按乡镇分组完成，共 X 个乡镇
处理乡镇: XXX, 社区数量: 3
乡镇 XXX 的 PLAN_CONSTRUCTION 聚合结果: sum=X, count=3, avg=Y
...
乡镇聚合完成，共 X 个乡镇
```

## 预期结果示例

### 输入（3个社区）
```json
{
  "regionCodes": ["511425108001", "511425108002", "511425108003"]
}
```

假设这3个社区都属于"瑞峰镇"，步骤1计算的能力值分别为：
- 社区1: PLAN_CONSTRUCTION = 0.50000000
- 社区2: PLAN_CONSTRUCTION = 0.60000000
- 社区3: PLAN_CONSTRUCTION = 0.70000000

### 输出（1个乡镇）
```json
{
  "tableData": [
    {
      "regionCode": "511425108001",
      "regionName": "社区1",
      "townshipName": "瑞峰镇",
      "communityName": "社区1",
      "Plan Construction": 0.60000000,  // (0.5 + 0.6 + 0.7) / 3
      "Hazard Inspection": ...,
      ...
    }
  ]
}
```

**注意**：
- 只返回1行数据（乡镇级别）
- `regionCode` 使用乡镇的第一个社区代码
- 所有能力值都是3个社区的平均值

## 故障排查

### 问题1：返回3行数据而不是1行
**原因**：后端服务没有重启，代码修改未生效

**解决**：重启后端服务

### 问题2：字段名还是 TOWNSHIP_PLAN_AGG
**原因**：数据库修改未执行

**解决**：执行步骤1的SQL语句

### 问题3：报错 "township_name 字段不存在"
**原因**：社区数据表中没有 township_name 字段

**解决**：检查数据库表结构，确保 `community_disaster_reduction_capacity` 表有 `township_name` 字段

### 问题4：所有值都是0
**原因**：步骤1的计算结果没有正确传递到步骤2

**解决**：检查步骤1的输出字段名是否正确

## 相关文件

- ✅ `ModelExecutionServiceImpl.java` - 后端代码（已修改）
- ✅ `fix_township_output_params.sql` - 数据库脚本（已执行）
- 📄 `test_township_aggregation.ps1` - 测试脚本
- 📄 `乡镇聚合真正修复总结.md` - 详细技术文档
- 📄 `乡镇聚合实现方案.md` - 方案分析文档

## 下一步

1. ⚠️ **重启后端服务**（最重要！）
2. 🧪 执行测试脚本
3. ✓ 验证结果
4. 📊 如果测试通过，可以在前端展示乡镇级别的数据

## 技术支持

如果遇到问题，请检查：
1. 后端服务是否已重启
2. 数据库修改是否已执行
3. 后端日志中是否有错误信息
4. 测试数据是否正确（社区是否有 township_name）
