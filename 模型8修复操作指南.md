# 模型8修复操作指南

## 当前状态

✅ **数据库配置**：已修复完成  
✅ **代码修改**：已完成  
⚠️ **后端服务**：需要重启  
⏳ **测试验证**：等待重启后测试

## 立即执行的操作

### 步骤1：重启后端服务 ⚠️ 必须执行

代码修改了`ModelExecutionServiceImpl.java`，必须重启后端才能生效。

**方法1：如果使用IDE运行**
- 停止当前运行的Spring Boot应用
- 重新启动

**方法2：如果使用命令行**
```bash
# 停止当前服务（Ctrl+C）
# 重新启动
mvn spring-boot:run
```

**方法3：如果使用jar包**
```bash
# 停止当前服务
# 重新打包
mvn clean package -DskipTests
# 启动
java -jar target/disaster-reduction-evaluation-1.0.0.jar
```

### 步骤2：验证修复

重启后，执行测试：

```powershell
.\test_model_8_curl.ps1
```

### 步骤3：检查结果

查看输出，应该看到：

**✅ 正确的结果**：
```json
{
  "PLAN_CONSTRUCTION": 1.0,  // 不再是0
  "HAZARD_INSPECTION": 1.0,  // 不再是0
  "RISK_ASSESSMENT": 1.0,    // 不再是0
  ...
}
```

**❌ 如果还是0**：
- 检查后端是否真的重启了
- 查看后端日志是否有错误
- 确认数据库修复脚本已执行

## 完整的修复清单

### ✅ 已完成的修复

1. **@WEIGHT标记修复**
   - 二级指标定权：3个算法
   - 能力值计算：1个算法

2. **输出参数字段名修复**
   - 归一化步骤：3个字段
   - 乡镇聚合步骤：1个字段

3. **归一化输入字段名修复**
   - 3个@NORMALIZE标记的输入字段

4. **数据源配置修复**
   - ModelExecutionServiceImpl.java：添加modelId=8的支持

### ⏳ 待执行的操作

1. **重启后端服务** ← 当前需要执行
2. **测试验证**
3. **确认结果正确**

## 预期结果

重启后，模型8应该能够正确计算：

### 社区指标计算（步骤1）

| 社区 | 预案建设 | 隐患排查 | 风险评估 | 财政投入 | ... |
|------|---------|---------|---------|---------|-----|
| 凤阳社区 | 1.0 | 1.0 | 1.0 | 0.0000492 | ... |
| 文林社区 | 1.0 | 0.5 | 1.0 | 0.0000914 | ... |

### 乡镇聚合（步骤2）

| 乡镇 | 预案建设 | 隐患排查 | 风险评估 | 财政投入 | ... |
|------|---------|---------|---------|---------|-----|
| 青竹街道 | 0.913 | 0.804 | 0.391 | 2.763 | ... |
| 汉阳镇 | 1.000 | 0.333 | 0.000 | 52.092 | ... |
| 瑞峰镇 | 1.000 | 0.875 | 0.500 | 20.589 | ... |

### 最终TOPSIS得分（步骤6）

| 乡镇 | 灾害管理能力 | 灾害备灾能力 | 自救转移能力 |
|------|------------|------------|------------|
| 青竹街道 | 0.XXX | 0.XXX | 0.XXX |
| 汉阳镇 | 0.XXX | 0.XXX | 0.XXX |
| 瑞峰镇 | 0.XXX | 0.XXX | 0.XXX |

## 如果遇到问题

### 问题1：重启后还是全0

**检查**：
1. 确认后端真的重启了（查看启动时间）
2. 查看后端日志，搜索"未找到社区数据"
3. 确认数据库中有数据：
   ```sql
   SELECT COUNT(*) FROM community_disaster_reduction_capacity;
   ```

### 问题2：某些字段还是0

**检查**：
1. 查看后端日志，搜索具体的错误信息
2. 确认数据库修复脚本已执行：
   ```sql
   SELECT COUNT(*) FROM step_algorithm sa
   JOIN model_step ms ON sa.step_id = ms.id
   WHERE ms.model_id = 8 AND sa.ql_expression LIKE '%@WEIGHT%';
   ```
   应该返回0

### 问题3：API调用失败

**检查**：
1. 后端服务是否正常运行
2. 端口8082是否被占用
3. 查看后端日志的错误信息

## 联系支持

如果按照以上步骤操作后仍有问题，请提供：
1. 后端日志（最近100行）
2. API响应内容
3. 数据库查询结果

---

**下一步**：立即重启后端服务！
