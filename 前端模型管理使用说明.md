# 前端模型管理功能使用说明

## 🎉 功能已上线

前端模型管理功能已完全实现并部署！

### 访问地址
**模型管理页面**: http://localhost:5174/model-management

### 主要功能

#### 1. 模型管理 (CRUD)

**功能列表:**
- ✅ **查看模型列表** - 显示所有评估模型
- ✅ **新建模型** - 创建新的评估模型
- ✅ **编辑模型** - 修改模型基本信息
- ✅ **删除模型** - 删除不需要的模型
- ✅ **配置模型** - 深入配置步骤和算法

**操作步骤:**
1. 访问 http://localhost:5174/model-management
2. 点击"新建模型"按钮
3. 填写模型信息：
   - 模型名称（必填）
   - 模型编码（必填，英文）
   - 版本号
   - 描述信息
4. 点击"保存"

#### 2. 步骤配置

**功能特性:**
- ✅ **添加步骤** - 为模型添加评估步骤
- ✅ **查看步骤** - 按执行顺序显示所有步骤
- ✅ **删除步骤** - 移除不需要的步骤
- ✅ **步骤类型** - 支持5种类型：
  - 指标计算 (CALCULATION)
  - 归一化 (NORMALIZATION)
  - 定权 (WEIGHTING)
  - TOPSIS算法 (TOPSIS)
  - 能力分级 (GRADING)

**操作步骤:**
1. 在模型列表点击"配置"按钮
2. 进入"步骤管理"标签页
3. 点击"添加步骤"
4. 填写步骤信息：
   - 步骤名称（如：评估指标赋值）
   - 步骤编码（如：INDICATOR_ASSIGNMENT）
   - 执行顺序（数字，决定执行顺序）
   - 步骤类型（下拉选择）
   - 描述
5. 点击"保存"

#### 3. 算法配置（QLExpress表达式）

**核心功能:**
- ✅ **添加算法** - 为步骤添加QLExpress表达式
- ✅ **编辑表达式** - 直接在表格中修改表达式
- ✅ **实时验证** - 自动验证表达式语法
- ✅ **测试表达式** - 使用测试数据验证表达式
- ✅ **保存更新** - 保存修改后的表达式
- ✅ **删除算法** - 移除不需要的算法

**操作步骤:**
1. 在步骤列表点击"算法配置"按钮
2. 切换到"算法配置"标签页
3. 点击"添加算法"
4. 填写算法信息：
   - 算法名称（如：队伍管理能力计算）
   - 算法编码（如：MANAGEMENT_CAPABILITY）
   - 执行顺序
   - **QLExpress表达式**（核心）
   - 输出参数名
   - 描述
5. 点击"保存"

### QLExpress表达式示例

#### 基础运算
```java
// 简单计算
(management_staff / population) * 10000

// 条件判断
risk_assessment == "是" ? 1 : 0

// 复杂计算
((firefighters + volunteers + militia_reserve) / population) * 10000
```

#### 统计函数
```java
// 平均值
AVERAGE(value1, value2, value3)

// 标准差
STDEV(all_values)

// 平方根
SQRT(value)

// 平方和
SUMSQ(all_values)

// 幂运算
POW(value, 2)
```

#### 归一化公式
```java
// 向量归一化
value / SQRT(SUMSQ(all_values))
```

#### TOPSIS算法
```java
// 正理想解距离
SQRT(POW(max1 - current1, 2) + POW(max2 - current2, 2))

// 负理想解距离
SQRT(POW(min1 - current1, 2) + POW(min2 - current2, 2))

// TOPSIS得分
negative_distance / (negative_distance + positive_distance)
```

#### 能力分级
```java
// 基于均值和标准差的分级
mean <= 0.5 * stdev ? 
  (value >= mean + 1.5 * stdev ? "强" : "中等") : 
  (value >= mean + 1.5 * stdev ? "强" : "较弱")
```

### 界面功能说明

#### 主界面（模型列表）
```
┌─────────────────────────────────────────────────┐
│  评估模型管理                    [新建模型]      │
├─────────────────────────────────────────────────┤
│ ID │ 模型名称 │ 编码 │ 描述 │ 版本 │ 状态 │操作 │
│ 1  │ 标准模型 │ STD  │ ... │ 1.0  │ 启用 │...  │
└─────────────────────────────────────────────────┘
```

#### 模型配置对话框
```
┌─────────────────────────────────────────────────┐
│  模型配置                                        │
├─────────────────────────────────────────────────┤
│ [步骤管理] [算法配置]                            │
│                                                  │
│ 步骤管理:                         [添加步骤]    │
│ ┌───────────────────────────────────────────┐   │
│ │ 顺序 │ 步骤名称 │ 类型 │ 描述 │ 操作      │   │
│ │  1   │ 指标赋值 │ 计算 │ ... │ [算法配置] │   │
│ └───────────────────────────────────────────┘   │
│                                                  │
│ 算法配置:                         [添加算法]    │
│ ┌───────────────────────────────────────────┐   │
│ │ 顺序 │ 算法名称 │ QLExpress表达式 │ 操作 │   │
│ │  1   │ 队伍计算 │ (staff/pop)*1e4 │ 保存 │   │
│ └───────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 使用流程

#### 完整的模型创建流程

1. **创建模型**
   ```
   访问模型管理 → 新建模型 → 填写信息 → 保存
   ```

2. **配置步骤**
   ```
   选择模型 → 配置 → 步骤管理 → 添加步骤（按顺序添加多个）
   ```

3. **配置算法**
   ```
   选择步骤 → 算法配置 → 添加算法 → 输入QLExpress表达式 → 验证 → 保存
   ```

4. **测试验证**
   ```
   编辑表达式 → 点击"测试"按钮 → 查看验证结果
   ```

#### 示例：创建"队伍管理能力计算"算法

```
步骤1: 点击"添加算法"
步骤2: 填写表单
  - 算法名称: 队伍管理能力计算
  - 算法编码: MANAGEMENT_CAPABILITY
  - 执行顺序: 1
  - QLExpress表达式: (management_staff / population) * 10000
  - 输出参数: management_capability
  - 描述: 计算每万人的灾害管理工作人员数量
步骤3: 点击"保存"
步骤4: 系统自动验证表达式语法
步骤5: 验证通过后保存到数据库
```

### 表达式验证

系统提供**两种验证方式**：

#### 1. 自动验证
- 输入框失焦时自动验证
- 保存前强制验证
- 无效表达式会阻止保存

#### 2. 手动测试
- 点击"测试"按钮
- 使用预设测试数据运行
- 显示验证结果

**测试数据示例:**
```json
{
  "management_staff": 10,
  "population": 1000,
  "value": 100
}
```

### 注意事项

#### ✅ 最佳实践

1. **步骤顺序很重要** - 后续步骤依赖前面步骤的输出
2. **变量命名一致** - 输出参数名要与后续步骤的输入变量名一致
3. **先测试再保存** - 使用"测试"功能验证复杂表达式
4. **及时保存** - 修改表达式后立即点击"保存"按钮

#### ⚠️ 常见错误

1. **语法错误**
   ```
   错误: (management_staff / population * 10000   // 缺少括号
   正确: (management_staff / population) * 10000
   ```

2. **变量名错误**
   ```
   错误: managementStaff  // 驼峰命名
   正确: management_staff  // 下划线命名
   ```

3. **函数调用错误**
   ```
   错误: SQRT value        // 缺少括号
   正确: SQRT(value)
   ```

### 快捷键和技巧

- **快速编辑**: 直接在表格单元格中编辑表达式
- **批量操作**: 按住Ctrl键可多选
- **搜索过滤**: 使用浏览器的Ctrl+F搜索特定模型或步骤

### 数据持久化

所有配置都实时保存到数据库：
- ✅ 模型信息 → `evaluation_model` 表
- ✅ 步骤配置 → `model_step` 表
- ✅ 算法表达式 → `step_algorithm` 表

### 系统状态

**当前运行状态:**
- 后端API: ✅ http://localhost:8081
- 前端界面: ✅ http://localhost:5174
- 模型管理: ✅ http://localhost:5174/model-management

### 故障排查

#### 问题1: 页面无法加载
```powershell
# 检查前端服务
netstat -an | findstr :5174

# 查看前端日志
Receive-Job -Name "VueApp" -Keep
```

#### 问题2: API调用失败
```powershell
# 检查后端服务
netstat -an | findstr :8081

# 测试API
Invoke-RestMethod -Uri "http://localhost:8081/api/model-management/models"
```

#### 问题3: 表达式验证失败
- 检查变量名是否与数据库字段匹配
- 检查括号是否配对
- 检查函数名是否正确（全大写）

### 下一步

完成模型配置后，您可以：
1. 在"评估计算"页面选择配置好的模型
2. 选择要评估的地区
3. 执行评估并查看结果
4. 生成专题图和报告

---

**功能状态**: 🟢 完全可用  
**文档版本**: 1.0  
**最后更新**: 2025-10-12