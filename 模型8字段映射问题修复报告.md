# 模型8字段映射问题修复报告

## 修复时间
2025-10-24

## 问题描述

修复了`@WEIGHT`标记问题后，模型8执行成功，但所有计算结果都是0。

## 问题原因

归一化步骤的输出字段名与二级指标定权步骤的输入字段名不匹配：

| 步骤 | 算法 | 输出字段名（错误） | 期望字段名（正确） |
|------|------|-------------------|-------------------|
| 归一化 | 算法3: Risk Assessment Norm | `riskAssessmentCapabilityNorm` | `RISK_ASSESSMENT_NORM` |
| 归一化 | 算法5: Material Reserve Norm | `materialReserveCapabilityNorm` | `MATERIAL_RESERVE_NORM` |
| 归一化 | 算法6: Medical Support Norm | `medicalSupportCapabilityNorm` | `MEDICAL_SUPPORT_NORM` |
| 乡镇聚合 | 算法7: Township Aid Aggregation | `NULL` | `TOWNSHIP_AID_AGG` |

### 影响

由于字段名不匹配，二级指标定权步骤无法找到这些字段的值，导致：
- `MATERIAL_RESERVE_NORM` 为 null → Support Weight = 0
- `MEDICAL_SUPPORT_NORM` 为 null → Support Weight = 0
- 最终所有计算结果都是0

## 修复内容

### 修复1：归一化步骤输出参数

```sql
-- 算法3：Risk Assessment Norm
UPDATE step_algorithm sa
JOIN model_step ms ON sa.step_id = ms.id
SET sa.output_param = 'RISK_ASSESSMENT_NORM'
WHERE ms.model_id = 8
  AND ms.step_code = 'VECTOR_NORMALIZATION'
  AND sa.algorithm_order = 3;

-- 算法5：Material Reserve Norm
UPDATE step_algorithm sa
JOIN model_step ms ON sa.step_id = ms.id
SET sa.output_param = 'MATERIAL_RESERVE_NORM'
WHERE ms.model_id = 8
  AND ms.step_code = 'VECTOR_NORMALIZATION'
  AND sa.algorithm_order = 5;

-- 算法6：Medical Support Norm
UPDATE step_algorithm sa
JOIN model_step ms ON sa.step_id = ms.id
SET sa.output_param = 'MEDICAL_SUPPORT_NORM'
WHERE ms.model_id = 8
  AND ms.step_code = 'VECTOR_NORMALIZATION'
  AND sa.algorithm_order = 6;
```

### 修复2：乡镇聚合步骤输出参数

```sql
-- 算法7：Township Aid Aggregation
UPDATE step_algorithm sa
JOIN model_step ms ON sa.step_id = ms.id
SET sa.output_param = 'TOWNSHIP_AID_AGG'
WHERE ms.model_id = 8
  AND ms.step_code = 'TOWNSHIP_AGGREGATION'
  AND sa.algorithm_order = 7;
```

## 执行的修复脚本

文件：`fix_model_8_output_params.sql`

## 验证

### 验证1：检查输出参数是否正确

```sql
SELECT 
    algorithm_order,
    algorithm_name,
    output_param
FROM step_algorithm sa
JOIN model_step ms ON sa.step_id = ms.id
WHERE ms.model_id = 8 AND ms.step_code = 'VECTOR_NORMALIZATION'
ORDER BY algorithm_order;
```

**期望结果**：所有output_param都应该是大写下划线格式（如`RISK_ASSESSMENT_NORM`）

### 验证2：执行评估

重新执行模型8评估，检查结果是否不再全部为0。

## 模型8完整修复清单

### 已修复的问题

1. ✅ **@WEIGHT标记问题**（二级指标定权步骤）
   - 算法2: Support Weight
   - 算法3: Capability Weight
   - 算法5: Comprehensive Weight

2. ✅ **@WEIGHT标记问题**（能力值计算步骤）
   - 算法1: Capability Score

3. ✅ **字段映射问题**（归一化步骤）
   - 算法3: Risk Assessment Norm
   - 算法5: Material Reserve Norm
   - 算法6: Medical Support Norm

4. ✅ **字段映射问题**（乡镇聚合步骤）
   - 算法7: Township Aid Aggregation

### 修复脚本汇总

1. `fix_model_8_all_weights.sql` - 修复所有@WEIGHT标记
2. `fix_model_8_output_params.sql` - 修复字段映射问题

## 命名规范建议

为避免类似问题，建议统一字段命名规范：

### 规范1：使用大写下划线格式

所有输出参数名应使用大写下划线格式：
- ✅ `RISK_ASSESSMENT_NORM`
- ✅ `MATERIAL_RESERVE_NORM`
- ✅ `MEDICAL_SUPPORT_NORM`
- ❌ `riskAssessmentCapabilityNorm`
- ❌ `materialReserveCapabilityNorm`

### 规范2：保持命名一致性

如果归一化步骤输出`RISK_ASSESSMENT_NORM`，后续步骤就应该使用`RISK_ASSESSMENT_NORM`，不要改名。

### 规范3：避免NULL输出参数

所有算法都应该有明确的输出参数名，不应该是NULL。

## 影响范围

- **影响模型**：社区-乡镇能力评估模型（model_id = 8）
- **影响步骤**：
  - 属性向量归一化（VECTOR_NORMALIZATION）
  - 乡镇数据聚合（TOWNSHIP_AGGREGATION）
- **修改算法数量**：4个算法

## 修复人员

Kiro AI Assistant

## 修复日期

2025-10-24
